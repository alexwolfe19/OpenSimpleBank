<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>OSB - Account Home</title>
    </head>
    <body>
        <div id="app">
            <h1>Account Home</h1>
            <hr>
            <div class="wallet-list">
                <h3>Wallets</h3>
                <table id="wallets">
                    <tr>
                        <th>#</th>
                        <th>Address</th>
                        <th>Label</th>
                        <th>Balance</th>
                        <th>Actions</th>
                    </tr>
                </table>
                <a href="/currencies.html">Currency list</a>
            </div>
            <div>
                <h3>Transfer Panel</h3>
                <p id="transfer-message"></p>
                <form>
                    <p>
                        Source Account
                        <select id="sources">
                        </select>
                    </p>
                    <p>
                        Destination Account
                        <input id="creditor">
                    </p>
                    <p>
                        Amount
                        <input id="amount">
                    </p>
                </form>
                <button onclick="sendPayment()">Pay</button>
            </div>
        </div>
    </body>

    <script>
        function sendPayment() {
            const source = document.getElementById('sources').value;
            const dest = document.getElementById('creditor').value;
            const value = document.getElementById('amount').value;


            makePOSTRequest('transaction/begin/', JSON.stringify({
                debtor: source,
                creditor: dest,
                value: value
            })).then(reply => {
                alert(":)")
                console.log(reply);
            }).catch(e => {
                alert(":(")
                console.error(e);
            })
        }

        async function makePOSTRequest(path, body) {
            if (typeof body == "object") body = JSON.stringify(body);
            const request = new Request(`/api/${path}`, {
                method: 'POST',
                body: body,
                headers: {"Content-Type": "application/json"}
            });
            const reply = await fetch(request);
            return reply;
        }

        async function makeGETRequest(path) {
            if (typeof body == "object") body = JSON.stringify(body);
            const request = new Request(`/api/${path}`, {
                method: 'GET'
            });
            const reply = await fetch(request);
            return reply;
        }

        function makeActionColumn(address) {
            const root = document.createElement('td');

            const showTransactionsButton = document.createElement('button');
            showTransactionsButton.innerText = "Show Transactions";
            root.appendChild(showTransactionsButton);

            const selectAsSourceButton = document.createElement('button');
            selectAsSourceButton.innerText = "Make Source";
            selectAsSourceButton.onclick = () => {
                const sourcelist = document.getElementById('sources');
                sourcelist.value = address;
            }
            root.appendChild(selectAsSourceButton);

            return root;
        }

        function load() {
            const table = document.getElementById('wallets');
            const sourcelist = document.getElementById('sources');

            makeGETRequest('wallet/list/').then(async (body) => {
                const list = await body.json();

                for (var count=0; count<list.length; count++) {
                    const wallet = list[count];
                    const row = document.createElement('tr');
                    const ncol = document.createElement('td');
                    const addr = document.createElement('td');
                    const label = document.createElement('td');
                    const balcol = document.createElement('td');
                    const actcol = makeActionColumn(wallet["id"]);

                    const source_option = document.createElement("option");
                    source_option.value = wallet["id"];
                    source_option.innerText = `Unnamed Wallet ${count + 1}`;
                    sourcelist.appendChild(source_option);

                    ncol.innerText = count + 1;
                    addr.innerText = wallet["id"];
                    label.innerText = `Unnamed Wallet ${count + 1}`;
                    balcol.innerText = wallet["balance"];

                    row.appendChild(ncol);
                    row.appendChild(addr);
                    row.appendChild(label);
                    row.appendChild(balcol);
                    row.appendChild(actcol);

                    row.setAttribute('wallet-address', wallet["id"])

                    table.appendChild(row);
                }

            })   
        }

        makeGETRequest("account/is-logged-in").then((r) => {
            if (r.status != 200) window.location = "/id.html"
            load();
        }).catch((e) => {
            console.error(e);
        });
    </script>
</html>